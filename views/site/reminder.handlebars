{{> header 
pageButtons='
<div class="user-menu" id="userMenu">
  <img src="/img/user-icon.png" alt="kullanıcı ikonu" />
  <div id="userDropdownToggle" style="display: flex; align-items: center; cursor: pointer;">
    <span id="userName"></span>
    <span class="arrow" id="arrow">▾</span>
  </div>
  <div class="dropdown" id="dropdown" style="display:none; position:absolute; background:white; border:1px solid #ccc; padding:5px;">
    <a href="/login/logout" style="text-decoration: none; color: inherit;"><button id="logoutBtn">Çıkış Yap</button></a>
    <button id="deleteAccountBtn">Hesabı Sil</button>
  </div>
</div>'
}}
  <main class="reminder-box">
    <div class="title-center">
      <img src="/img/reminder.png" alt="Hatırlatıcı İkonu" class="reminder-img">
      <h2>HATIRLATICI</h2>
    </div>    
    <div class="form-section">
      <label>Tarih</label>
      <input type="date" id="dateInput" min="" max="" required>

      <label>Saat</label>
      <input type="time" id="timeInput" required>

      <div id="additionalFields" style="display:none;">
        <label>Etkinlik Başlığı</label>
        <input type="text" id="titleInput" placeholder="Etkinlik başlığı">

        <label>Açıklama</label>
        <textarea id="descInput" placeholder="Etkinlik açıklaması..."></textarea>

        <label>Bildirim Yöntemi</label>
        <select id="notifyOption">
          <option value="email">E-posta</option>
          <option value="sms">SMS</option>
        </select>

        <input type="email" id="emailInput" placeholder="E-posta adresi">
        <input type="tel" id="phoneInput" placeholder="Telefon numarası">

        <button type="button" id="reminderAddBtn">Hatırlatıcıyı Ekle</button>
      </div>
    </div>

    <h3>Eklenen Hatırlatıcılar</h3>
    <ul id="reminderList"></ul>
  </main>
  <script>
// Sayfa yüklendiğinde kullanıcı adını ayarla
document.addEventListener('DOMContentLoaded', function() {
  const userNameElement = document.getElementById('userName');
  const userName = "{{userName}}";
  
  if (userName) {
    userNameElement.textContent = userName;
    console.log("Kullanıcı adı ayarlandı:", userName);
  } else {
    console.log("Kullanıcı adı bulunamadı");
  }

  // Mevcut hatırlatıcıları yükle
  loadReminders();

  document.getElementById("userDropdownToggle").addEventListener("click", function() {
    const dropdown = document.getElementById("dropdown");
    dropdown.style.display = dropdown.style.display === "none" ? "block" : "none";
  });

  document.getElementById("deleteAccountBtn").addEventListener("click", async function() {
    if (confirm("Hesabınızı silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!")) {
      try {
        const response = await fetch("/login/delete-account", {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json"
          }
        });
        const data = await response.json();
        
        if (data.success) {
          alert(data.message);
          window.location.href = data.redirect;
        } else {
          alert(data.message);
        }
      } catch (err) {
        console.error("Hesap silme hatası:", err);
        alert("Hesap silinirken bir hata oluştu");
      }
    }
  });
});

// Hatırlatıcıları yükle
async function loadReminders() {
  try {
    const response = await fetch('/reminder/list');
    const reminders = await response.json();
    const list = document.getElementById('reminderList');
    list.innerHTML = ''; // Listeyi temizle
    
    reminders.forEach(reminder => {
      const li = document.createElement('li');
      const date = new Date(reminder.date).toLocaleString('tr-TR');
      li.textContent = `${date} - ${reminder.title} (${reminder.notifyType.toUpperCase()})`;
      list.appendChild(li);
    });
  } catch (error) {
    console.error('Hatırlatıcılar yüklenirken hata:', error);
  }
}

async function addReminder() {
  console.log("addReminder fonksiyonu tetiklendi");
  const data = {
    title: document.getElementById('titleInput').value,
    description: document.getElementById('descInput').value,
    date: new Date(document.getElementById('dateInput').value + 'T' + document.getElementById('timeInput').value),
    notifyType: document.getElementById('notifyOption').value,
    email: document.getElementById('emailInput').value,
    phone: document.getElementById('phoneInput').value
  };
  console.log("Gönderilen veri:", data);
  
  try {
    const response = await fetch('/reminder/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    const result = await response.json();
    alert(result.message);
    
    if (result.success) {
      // Form alanlarını temizle
      document.getElementById('titleInput').value = '';
      document.getElementById('descInput').value = '';
      document.getElementById('dateInput').value = '';
      document.getElementById('timeInput').value = '';
      document.getElementById('emailInput').value = '';
      document.getElementById('phoneInput').value = '';
      
      // Hatırlatıcıları yeniden yükle
      await loadReminders();
    }
  } catch (error) {
    console.error('Hatırlatıcı eklenirken hata:', error);
    alert('Bir hata oluştu, lütfen tekrar deneyin.');
  }
}

document.getElementById('reminderAddBtn').addEventListener('click', addReminder);
</script>